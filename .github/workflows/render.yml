on:
  push:
    branches:
      - new_main
    # paths: ['**.Rmd', '**.qmd'']


name: render-markdown
         
jobs:
  render-rmarkdown:
    runs-on: ubuntu-latest
    steps:
          - name: Check out the repo
            uses: actions/checkout@v3
            with:
              fetch-depth: 0
            env:
              GITHUB_PAT: ${{ secrets.GH_TOKEN }}
          - name: Run the build process with Docker
            uses: addnab/docker-run-action@v3
            with:
                image: meenaljhajharia/bda-docker:latest
                options: -v ${{ github.workspace }}:/work
                shell: bash
                run: |
                  cd /work
                  git config --global --add safe.directory /work
                  git config --global user.name "mjhajharia"
                  git config --global user.email "meenal@mjhajharia.com"
                  git checkout new_main
                  git diff --name-only HEAD^ | grep '[.]*Rmd$' > last_modified_rmd_files.txt
                  while read -r filename; do   echo "$filename"; Rscript -e "rmarkdown::render('$filename')";   done < last_modified_rmd_files.txt
                  git diff --name-only HEAD^ | grep '[.]*qmd$' > last_modified_qmd_files.txt
                  while read -r filename; do   echo "$filename"; quarto render $filename;   done < last_modified_qmd_files.txt
                  git add -A
                  git commit -m "Render Rmd files"
                  git diff --name-only --diff-filter=A HEAD^ > new_files.txt
                  git checkout new_gh-pages
                  git checkout new_main -- $(cat new_files.txt)
                  git commit -m "Deploy to GitHub Pages"
                  git push origin new_gh-pages

